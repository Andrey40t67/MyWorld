 <!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Мегатрекинг рук + рисование (Canvas)</title>
<style>
  :root{--ui:#9fe6ff}
  html,body{margin:0;height:100%;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #stage{position:fixed;inset:0;touch-action:none;overscroll-behavior:none}
  canvas{position:absolute;inset:0;display:block;width:100%;height:100%}
  #view{z-index:0} #paint{z-index:1}
  #hud{position:fixed;left:0;right:0;top:0;padding:8px 10px;color:var(--ui);font-size:12px;mix-blend-mode:screen;pointer-events:none;text-shadow:0 0 8px #0ff8}
  #panel{position:fixed;right:8px;bottom:8px;display:flex;gap:8px;align-items:center;background:#0a0f14cc;border:1px solid #2aa9ff55;border-radius:12px;padding:8px 10px;backdrop-filter:blur(8px)}
  #panel>*{color:#dff}
  button,select,input[type=color],input[type=range]{background:#0c151c;border:1px solid #2aa9ff66;border-radius:8px;color:#dff;padding:8px 10px}
  button:active{transform:scale(.97)}
  #start{position:fixed;inset:0;margin:auto;width:max(260px,60vw);max-width:420px;height:120px;border-radius:14px;font-size:18px;z-index:5}
  #error{position:fixed;inset:0;display:none;align-items:center;justify-content:center;color:#fff;background:#000;z-index:6;padding:20px;text-align:center}
  .badge{position:fixed;left:8px;bottom:8px;color:#9fe6ff;font-size:11px;opacity:.85}
</style>
</head>
<body>
  <div id="stage">
    <canvas id="view"></canvas>
    <canvas id="paint"></canvas>
  </div>
  <div id="hud">Готово к старту. Нажми «Разрешить камеру».</div>

  <button id="start">▶ Разрешить камеру и начать</button>
  <div id="error"></div>
  <div class="badge">mediapipe hands • canvas • pinch-draw</div>

  <!-- Скрытое видео для чтения с камеры -->
  <video id="video" playsinline muted style="display:none"></video>

<script>
/* ====== Загрузчик MediaPipe с резервными CDN ====== */
const MP_VERSION = '0.4.1646424915';
const CDNS = [
  'https://cdn.jsdelivr.net/npm',
  'https://unpkg.com'
];
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>res();s.onerror=()=>rej(new Error('load '+src));document.head.appendChild(s);});}

async function loadMediapipe(){
  let lastErr=null;
  for(const base of CDNS){
    try{
      // порядок важен: camera_utils -> drawing_utils -> hands
      await loadScript(`${base}/@mediapipe/camera_utils@${MP_VERSION}/camera_utils.js`);
      await loadScript(`${base}/@mediapipe/drawing_utils@${MP_VERSION}/drawing_utils.js`);
      await loadScript(`${base}/@mediapipe/hands@${MP_VERSION}/hands.js`);
      return {base};
    }catch(e){ lastErr=e; }
  }
  throw lastErr||new Error('Не удалось загрузить MediaPipe');
}

/* ====== Утилиты ====== */
const $ = sel => document.querySelector(sel);
const hud = $('#hud');
const errBox = $('#error');
function showError(msg){
  errBox.style.display='flex';
  errBox.textContent = msg;
}

/* ====== Основной код ====== */
const video = $('#video');
const canvView = $('#view');
const canvPaint = $('#paint');
const ctxView = canvView.getContext('2d');
const ctxPaint = canvPaint.getContext('2d');

const ui = {
  color: '#55e1ff',
  size: 8,
  debug: true
};

// Панель управления
const panel = document.createElement('div');
panel.id='panel';
panel.innerHTML = `
  <label>Цвет <input id="clr" type="color" value="${ui.color}"></label>
  <label>Толщина <input id="th" type="range" min="2" max="24" step="1" value="${ui.size}"></label>
  <button id="clear">Очистить</button>
  <button id="dbg">Отладка: вкл</button>
`;
document.body.appendChild(panel);
$('#clr').oninput = e=> ui.color = e.target.value;
$('#th').oninput  = e=> ui.size = +e.target.value;
$('#clear').onclick= ()=>{ ctxPaint.clearRect(0,0,canvPaint.width,canvPaint.height); };
$('#dbg').onclick = e=>{ ui.debug=!ui.debug; e.target.textContent = 'Отладка: '+(ui.debug?'вкл':'выкл'); };

function resize(){
  const dpr = Math.min(window.devicePixelRatio||1, 2);
  const w = innerWidth, h = innerHeight;
  for (const c of [canvView, canvPaint]){
    c.width = Math.round(w*dpr); c.height = Math.round(h*dpr);
    c.style.width = w+'px'; c.style.height = h+'px';
    const ctx = c.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
}
addEventListener('resize', resize); resize();

/* ====== Логика рисования «щепоткой» ====== */
const strokes = {
  Left: { drawing:false, last:null },
  Right:{ drawing:false, last:null }
};
function drawPointLine(handed, x, y){
  const s = strokes[handed];
  ctxPaint.lineCap='round'; ctxPaint.lineJoin='round';
  ctxPaint.strokeStyle = ui.color; ctxPaint.lineWidth = ui.size;
  ctxPaint.beginPath();
  if(s.last){ ctxPaint.moveTo(s.last.x, s.last.y); ctxPaint.lineTo(x,y); }
  else { ctxPaint.moveTo(x,y); ctxPaint.lineTo(x+0.01,y+0.01); }
  ctxPaint.stroke();
  s.last = {x,y};
}
function stopDraw(handed){ strokes[handed].drawing=false; strokes[handed].last=null; }

/* ====== Старт камеры и трекинга ====== */
async function start(){
  // Проверка secure context для камеры
  if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1'){
    showError('Камера в браузере работает только по HTTPS или с http://localhost. Залей на GitHub Pages/Netlify или открой локально.');
    return;
  }

  let mpBase;
  try{
    ({base: mpBase} = await loadMediapipe());
  }catch(e){
    showError('Не удалось загрузить MediaPipe Hands. Проверь интернет/VPN.'); return;
  }

  // Инициализируем Hands
  const hands = new Hands({
    locateFile: (file) => `${mpBase}/@mediapipe/hands@${MP_VERSION}/${file}`
  });
  hands.setOptions({
    maxNumHands: 2,
    modelComplexity: 1,
    selfieMode: true,
    minDetectionConfidence: 0.65,
    minTrackingConfidence: 0.55
  });

  hands.onResults(onResults);

  // Запускаем камеру
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:'user', width: {ideal: 1280}, height: {ideal: 720} },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
  }catch(e){
    showError('Нет доступа к камере. Разреши доступ или выбери камеру в браузере.'); return;
  }

  // Камера-луп из mediaPipe utils (передаём кадр в Hands)
  const cam = new Camera(video, {
    onFrame: async () => { await hands.send({image: video}); },
    width: 1280, height: 720
  });
  cam.start();

  $('#start').style.display='none';
  errBox.style.display='none';
  hud.textContent = 'Щепотка (большой+указательный) — рисовать. Кнопка «Очистить» — стереть.';
}

/* ====== Рендер коллапс: кадр камеры + разметка ====== */
function onResults(results){
  const img = results.image;
  // Подгон канваса (CSS уже растягивает, тут важны реальные пиксели для drawImage)
  const needResize = (canvView.width !== img.width || canvView.height !== img.height);
  if(needResize){
    // Сохраняем нарисованное: у нас отдельный слой paint, так что просто ресайзим view.
    canvView.width = img.width; canvView.height = img.height;
    canvView.style.width='100%'; canvView.style.height='100%';
    // paint оставляем в CSS-режиме, чтобы не смазывать рисунок; слой выше тянется на экран.
    resize();
  }

  // Камера на view-слое
  ctxView.save();
  ctxView.clearRect(0,0,canvView.width,canvView.height);
  // В selfieMode картинка уже зеркальная, рисуем как есть:
  ctxView.drawImage(img, 0, 0, canvView.width, canvView.height);

  // Отрисовка скелета/точек + расчёт жестов
  if (results.multiHandLandmarks && results.multiHandLandmarks.length){
    for (let i=0;i<results.multiHandLandmarks.length;i++){
      const lm = results.multiHandLandmarks[i];
      const handed = (results.multiHandedness && results.multiHandedness[i] && results.multiHandedness[i].label) || (i===0?'Right':'Left');

      if (ui.debug){
        // линии и точки
        drawConnectors(ctxView, lm, HAND_CONNECTIONS, {color:'#00ffc8', lineWidth: 2});
        drawLandmarks(ctxView, lm, {color:'#ff5c9a', lineWidth: 1, radius: 2});
        // подпись
        ctxView.fillStyle = '#bdefff';
        ctxView.font = '14px system-ui';
        const p0 = lm[0];
        ctxView.fillText(handed, p0.x*canvView.width+8, p0.y*canvView.height+4);
      }

      // Жест "щепотка": расстояние между большим (4) и указательным (8)
      const pThumb = lm[4], pIndex = lm[8];
      const dx = (pThumb.x - pIndex.x) * canvView.width;
      const dy = (pThumb.y - pIndex.y) * canvView.height;
      const dist = Math.hypot(dx,dy);
      const thresh = Math.max(20, Math.min(canvView.width, canvView.height) * 0.035); // адаптивный порог

      const x = lm[8].x * canvView.width;
      const y = lm[8].y * canvView.height;

      if (dist < thresh){
        // рисуем
        if (!strokes[handed].drawing){ strokes[handed].drawing=true; strokes[handed].last=null; }
        drawPointLine(handed, x, y);
        if (ui.debug){
          ctxView.beginPath(); ctxView.arc(x,y, Math.max(6, ui.size), 0, Math.PI*2);
          ctxView.strokeStyle='#55e1ff88'; ctxView.lineWidth=2; ctxView.stroke();
        }
      } else {
        if (strokes[handed].drawing) stopDraw(handed);
      }
    }
  } else {
    // нет рук — сброс состояний
    stopDraw('Left'); stopDraw('Right');
  }
  ctxView.restore();

  // HUD
  // Простейший FPS счётчик
  fpsCount();
  hud.textContent = `FPS ~ ${fps.toFixed(0)} • жест: щепотка = рисовать • цвет ${ui.color} • толщина ${ui.size}`;
}

/* ====== FPS ====== */
let fps=60, _acc=0, _frames=0, _t0=performance.now();
function fpsCount(){
  const now = performance.now(); _frames++; _acc += 1000/(now-_t0); _t0 = now;
  if (_frames>=12){ fps=_acc/_frames; _acc=0; _frames=0; }
}

/* ====== Кнопка Старт ====== */
document.getElementById('start').addEventListener('click', start);
</script>
</body>
</html>
